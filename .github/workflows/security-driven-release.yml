name: Security-Driven Release

on:
  schedule:
    # Weekly security scan and release check on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even if no security changes detected'
        required: false
        default: false
        type: boolean
      custom_notes:
        description: 'Custom release notes'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.12'

jobs:
  security-change-analysis:
    name: Security Change Analysis
    runs-on: ubuntu-latest
    
    outputs:
      should_release: ${{ steps.release_decision.outputs.should_release }}
      release_type: ${{ steps.release_decision.outputs.release_type }}
      release_notes: ${{ steps.release_decision.outputs.release_notes }}
      justification: ${{ steps.release_decision.outputs.justification }}
      changes_detected: ${{ steps.release_decision.outputs.changes_detected }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparison
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source $HOME/.cargo/env
      
      - name: Install dependencies
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv sync --group dev --group security
      
      - name: Run current security scan
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "🔍 Running current security scan..."
          
          # Ensure reports directory exists
          mkdir -p security/reports/latest
          
          # Run dependency security scan
          uv add --dev pip-audit
          uv run pip-audit --format=json --output=security/reports/latest/pip-audit.json || echo "Dependency scan completed"
          
          # Run code security analysis
          uv add --dev bandit
          uv run bandit -r src/ -f json -o security/reports/latest/bandit.json || echo "Code analysis completed"
          
          # Run secret detection (simplified for workflow)
          echo '[]' > security/reports/latest/secrets-scan.json
          
          echo "✅ Security scan completed"
      
      - name: Update security findings
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "📋 Updating security findings document..."
          
          # Update findings document
          uv run python security/scripts/update-findings.py --verbose
          
          echo "✅ Security findings updated"
      
      - name: Analyze security changes and make release decision
        id: release_decision
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "🤔 Analyzing security changes for release decision..."
          
          # Create release decision script
          cat > analyze_release_decision.py << 'EOF'
          import json
          import os
          import sys
          from pathlib import Path
          
          # Add scripts to path
          sys.path.insert(0, 'scripts')
          
          from security_change_detector import SecurityChangeDetector
          from release_automation_engine import ReleaseAutomationEngine
          
          def main():
              try:
                  # Initialize components
                  detector = SecurityChangeDetector()
                  engine = ReleaseAutomationEngine()
                  
                  # Detect changes from current scan
                  changes = detector.detect_changes_from_current_scan(days_back=7)
                  
                  # Check for manual trigger
                  force_release = os.getenv('FORCE_RELEASE', 'false').lower() == 'true'
                  custom_notes = os.getenv('CUSTOM_NOTES', '')
                  
                  # Make release decision
                  decision = engine.make_release_decision(
                      changes, 
                      manual_trigger=force_release,
                      custom_notes=custom_notes if custom_notes else None
                  )
                  
                  # Output results
                  print(f"Should release: {decision.should_release}")
                  print(f"Release type: {decision.trigger_type.value}")
                  print(f"Justification: {decision.justification}")
                  print(f"Changes detected: {len(changes)}")
                  
                  # Set GitHub outputs
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"should_release={str(decision.should_release).lower()}\n")
                      f.write(f"release_type={decision.trigger_type.value}\n")
                      f.write(f"justification={decision.justification}\n")
                      f.write(f"changes_detected={len(changes)}\n")
                  
                  # Save release notes to file (escape newlines for GitHub)
                  release_notes_escaped = decision.release_notes.replace('\n', '\\n').replace('\r', '\\r')
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"release_notes={release_notes_escaped}\n")
                  
                  # Create detailed analysis file
                  analysis = {
                      "should_release": decision.should_release,
                      "release_type": decision.trigger_type.value,
                      "justification": decision.justification,
                      "release_notes": decision.release_notes,
                      "changes_count": len(changes),
                      "changes": [
                          {
                              "type": change.change_type.value,
                              "finding_id": change.finding_id,
                              "impact_level": change.impact_level,
                              "old_state": change.old_state,
                              "new_state": change.new_state,
                          }
                          for change in changes
                      ]
                  }
                  
                  with open('release_analysis.json', 'w') as f:
                      json.dump(analysis, f, indent=2)
                  
                  print("✅ Release decision analysis completed")
                  
              except Exception as e:
                  print(f"❌ Error in release decision analysis: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)
          
          if __name__ == "__main__":
              main()
          EOF
          
          # Run the analysis
          uv run python analyze_release_decision.py
        env:
          FORCE_RELEASE: ${{ github.event.inputs.force_release }}
          CUSTOM_NOTES: ${{ github.event.inputs.custom_notes }}
      
      - name: Display release decision
        run: |
          echo "🎯 Release Decision Results:"
          echo "Should Release: ${{ steps.release_decision.outputs.should_release }}"
          echo "Release Type: ${{ steps.release_decision.outputs.release_type }}"
          echo "Justification: ${{ steps.release_decision.outputs.justification }}"
          echo "Changes Detected: ${{ steps.release_decision.outputs.changes_detected }}"
          echo ""
          
          if [ -f "release_analysis.json" ]; then
            echo "📊 Detailed Analysis:"
            cat release_analysis.json | jq '.'
          fi
      
      - name: Upload release analysis
        uses: actions/upload-artifact@v4
        with:
          name: release-analysis
          path: |
            release_analysis.json
            security/findings/SECURITY_FINDINGS.md
          if-no-files-found: warn

  trigger-pypi-release:
    name: Trigger PyPI Release
    runs-on: ubuntu-latest
    needs: security-change-analysis
    if: needs.security-change-analysis.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download release analysis
        uses: actions/download-artifact@v4
        with:
          name: release-analysis
      
      - name: Trigger PyPI publishing workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseType = '${{ needs.security-change-analysis.outputs.release_type }}';
            const releaseNotes = `${{ needs.security-change-analysis.outputs.release_notes }}`.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
            const justification = '${{ needs.security-change-analysis.outputs.justification }}';
            
            console.log('🚀 Triggering PyPI publishing workflow...');
            console.log(`Release Type: ${releaseType}`);
            console.log(`Justification: ${justification}`);
            
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pypi-publish.yml',
              ref: 'main',
              inputs: {
                release_type: releaseType,
                release_notes: `${justification}\n\n${releaseNotes}`,
                dry_run: false
              }
            });
            
            console.log('✅ PyPI publishing workflow triggered successfully');
            console.log(`Workflow dispatch response: ${response.status}`);

  no-release-summary:
    name: No Release Summary
    runs-on: ubuntu-latest
    needs: security-change-analysis
    if: needs.security-change-analysis.outputs.should_release == 'false'
    
    steps:
      - name: Display no-release summary
        run: |
          echo "📋 No Release Required"
          echo "===================="
          echo ""
          echo "Justification: ${{ needs.security-change-analysis.outputs.justification }}"
          echo "Changes Detected: ${{ needs.security-change-analysis.outputs.changes_detected }}"
          echo ""
          echo "✅ Security posture is stable - no release needed"
          echo "📅 Next scheduled check: Next Monday at 3 AM UTC"

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [security-change-analysis, trigger-pypi-release, no-release-summary]
    if: always()
    
    steps:
      - name: Generate workflow summary
        run: |
          echo "# Security-Driven Release Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.security-change-analysis.result }}" = "success" ]; then
            echo "✅ **Security Analysis**: Completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Security Analysis**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Release Decision**: ${{ needs.security-change-analysis.outputs.should_release }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type**: ${{ needs.security-change-analysis.outputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Justification**: ${{ needs.security-change-analysis.outputs.justification }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Detected**: ${{ needs.security-change-analysis.outputs.changes_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.security-change-analysis.outputs.should_release }}" = "true" ]; then
            if [ "${{ needs.trigger-pypi-release.result }}" = "success" ]; then
              echo "🚀 **PyPI Release**: Triggered successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **PyPI Release**: Failed to trigger" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ **PyPI Release**: Skipped (no release needed)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Check**: Next Monday at 3 AM UTC (scheduled)" >> $GITHUB_STEP_SUMMARY